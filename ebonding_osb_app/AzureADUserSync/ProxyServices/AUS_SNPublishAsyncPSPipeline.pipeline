<?xml version="1.0" encoding="UTF-8"?>
<con:pipelineEntry xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con1="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:con4="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/publish/config">
    <con:coreEntry>
        <con:binding type="Any XML"/>
        <con:xqConfiguration>
            <con:snippetVersion>1.0</con:snippetVersion>
        </con:xqConfiguration>
    </con:coreEntry>
    <con:router errorHandler="error-a013dc6.460d90c.0.1660b304c78.N7dc2">
        <con:pipeline type="response" name="response-a013dc6.N2d0d734a.0.165fbf2cec9.N7f9c">
            <con:stage id="_StageId-a013dc6.460d90c.0.1660b304c78.N7f61" name="UpdateAUSTransaction" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                <con:context>
                    <con1:userNsDecl prefix="upd" namespace="http://xmlns.oracle.com/pcbpel/adapter/db/top/UpdateAUSTransaction" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
                </con:context>
                <con:actions>
                    <con4:ifThenElse xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-a013dc6.460d90c.0.1660b304c78.N7ee4</con5:id>
                        <con4:case id="_BranchId-a013dc6.460d90c.0.1660b304c78.N7ee3">
                            <con4:condition>
                                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$LastRecord='Y'</con5:xqueryText>
                            </con4:condition>
                            <con4:actions>
                                <con3:route>
                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-a013dc6.460d90c.0.1660b304c78.N7f60</con5:id>
                                    <con3:service ref="AzureADUserSync/BusinessServices/UpdateAUSTransaction" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con3:operation>merge</con3:operation>
                                    <con3:outboundTransform>
                                        <con2:replace contents-only="true" varName="body">
                                            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-a013dc6.460d90c.0.1660b304c78.N7f5f</con5:id>
                                            <con2:location>
                                                <con1:xpathText xmlns:con5="http://www.bea.com/wli/sb/stages/config">.</con1:xpathText>
                                            </con2:location>
                                            <con2:expr>
                                                <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                                                    <con6:resource ref="AzureADUserSync/Resources/XQueries/UpdateAUSTransactionRequest"/>
                                                    <con6:param name="Status">
                                                        <con6:path>'PROCESSED'</con6:path>
                                                    </con6:param>
                                                    <con6:param name="NextLink">
                                                        <con6:path>''</con6:path>
                                                    </con6:param>
                                                    <con6:param name="Deltalink">
                                                        <con6:path>''</con6:path>
                                                    </con6:param>
                                                    <con6:param name="RecordType">
                                                        <con6:path>''</con6:path>
                                                    </con6:param>
                                                    <con6:param name="errCode">
                                                        <con6:path>''</con6:path>
                                                    </con6:param>
                                                    <con6:param name="BatchId">
                                                        <con6:path>$BatchId</con6:path>
                                                    </con6:param>
                                                    <con6:param name="errMsg">
                                                        <con6:path>''</con6:path>
                                                    </con6:param>
                                                    <con6:param name="Payload">
                                                        <con6:path>''</con6:path>
                                                    </con6:param>
                                                    <con6:param name="RecordCount">
                                                        <con6:path>''</con6:path>
                                                    </con6:param>
                                                    <con6:param name="TransactionId">
                                                        <con6:path>$TranId</con6:path>
                                                    </con6:param>
                                                </con6:xqueryTransform>
                                            </con2:expr>
                                        </con2:replace>
                                        <con6:log xmlns:con6="http://www.bea.com/wli/sb/stages/logging/config">
                                            <con7:id xmlns:con7="http://www.bea.com/wli/sb/stages/config">_ActionId-3904eaa8.5b9cbcd4.0.166d0250582.N7ffe</con7:id>
                                            <con6:logLevel>warning</con6:logLevel>
                                            <con6:expr>
                                                <con7:xqueryText xmlns:con7="http://www.bea.com/wli/sb/stages/config">$body</con7:xqueryText>
                                            </con6:expr>
                                            <con6:message>****AUS_SNPublish.UpdateAUSTransaction.Record****</con6:message>
                                        </con6:log>
                                    </con3:outboundTransform>
                                </con3:route>
                                <con4:ifThenElse>
                                    <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7dfb</con6:id>
                                    <con4:case id="_BranchId-3904eaa8.N5c714004.0.166cb55bbc9.N7dfa">
                                        <con4:condition>
                                            <con6:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config">(xs:integer(fn-bea:execute-sql('jdbc/ESBDevDB',
xs:QName('COUNT'),
'select COUNT(*) from AUS_TRANSACTIONS where BATCH_ID=? AND RECORD_TYPE=?',$BatchId,'RECORD')//COUNT_x0028__x00210__x0029_/text())=xs:integer(fn-bea:execute-sql('jdbc/ESBDevDB',
xs:QName('COUNT'),
'select COUNT(*) from AUS_TRANSACTIONS where BATCH_ID=? AND RECORD_TYPE=? AND STATUS=?',$BatchId,'RECORD','PROCESSED')//COUNT_x0028__x00210__x0029_/text())) and fn:exists(fn-bea:execute-sql('jdbc/ESBDevDB',
xs:QName('DELTALINK'),
'select DELTALINK from AUS_TRANSACTIONS where BATCH_ID=? AND RECORD_TYPE=?',$BatchId,'BATCH')//DELTALINK/text())</con6:xqueryText>
                                        </con4:condition>
                                        <con4:actions>
                                            <con3:route>
                                                <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d92</con6:id>
                                                <con3:service ref="AzureADUserSync/BusinessServices/UpdateAUSTransaction" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con3:operation>merge</con3:operation>
                                                <con3:outboundTransform>
                                                    <con2:replace contents-only="true" varName="body">
                                                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d91</con6:id>
                                                        <con2:location>
                                                            <con1:xpathText xmlns:con5="http://www.bea.com/wli/sb/stages/config">.</con1:xpathText>
                                                        </con2:location>
                                                        <con2:expr>
                                                            <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                                                                <con6:resource ref="AzureADUserSync/Resources/XQueries/UpdateAUSTransactionRequest"/>
                                                                <con6:param name="Status">
                                                                    <con6:path>'PROCESSED'</con6:path>
                                                                </con6:param>
                                                                <con6:param name="NextLink">
                                                                    <con6:path>''</con6:path>
                                                                </con6:param>
                                                                <con6:param name="Deltalink">
                                                                    <con6:path>''</con6:path>
                                                                </con6:param>
                                                                <con6:param name="RecordType">
                                                                    <con6:path>''</con6:path>
                                                                </con6:param>
                                                                <con6:param name="errCode">
                                                                    <con6:path>''</con6:path>
                                                                </con6:param>
                                                                <con6:param name="BatchId">
                                                                    <con6:path>$BatchId</con6:path>
                                                                </con6:param>
                                                                <con6:param name="errMsg">
                                                                    <con6:path>''</con6:path>
                                                                </con6:param>
                                                                <con6:param name="Payload">
                                                                    <con6:path>''</con6:path>
                                                                </con6:param>
                                                                <con6:param name="RecordCount">
                                                                    <con6:path>''</con6:path>
                                                                </con6:param>
                                                                <con6:param name="TransactionId">
                                                                    <con6:path>$BatchTransactionId</con6:path>
                                                                </con6:param>
                                                            </con6:xqueryTransform>
                                                        </con2:expr>
                                                    </con2:replace>
                                                    <con6:log xmlns:con6="http://www.bea.com/wli/sb/stages/logging/config">
                                                        <con7:id xmlns:con7="http://www.bea.com/wli/sb/stages/config">_ActionId-3904eaa8.5b9cbcd4.0.166d0250582.N7ff8</con7:id>
                                                        <con6:logLevel>warning</con6:logLevel>
                                                        <con6:expr>
                                                            <con7:xqueryText xmlns:con7="http://www.bea.com/wli/sb/stages/config">$body</con7:xqueryText>
                                                        </con6:expr>
                                                        <con6:message>****AUS_SNPublish.UpdateAUSTransaction.Batch****</con6:message>
                                                    </con6:log>
                                                </con3:outboundTransform>
                                            </con3:route>
                                            <con4:wsCallout>
                                                <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N3f575e5a.N78f33e8.0.166e4c80cda.N7fcd</con6:id>
                                                <con4:service ref="AzureADUserSync/BusinessServices/ServiceNow/AUS_SNStartSync" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con4:operation>execute</con4:operation>
                                                <con4:request>
                                                    <con4:body wrapped="false">AUS_StartSyncReq</con4:body>
                                                </con4:request>
                                                <con4:response>
                                                    <con4:body wrapped="false">AUS_StartSyncReq</con4:body>
                                                </con4:response>
                                                <con4:requestTransform>
                                                    <con4:assign varName="AUS_StartSyncReq">
                                                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N3f575e5a.N78f33e8.0.166e4c80cda.N7fca</con6:id>
                                                        <con4:expr>
                                                            <con6:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config"><![CDATA[<sita:execute 	xmlns:sita="http://www.service-now.com/SITA_AZURE_SN_USERS">
<start_sync>true</start_sync>
<data_source>Azure</data_source>
</sita:execute>]]></con6:xqueryText>
                                                        </con4:expr>
                                                    </con4:assign>
                                                    <con6:log xmlns:con6="http://www.bea.com/wli/sb/stages/logging/config">
                                                        <con7:id xmlns:con7="http://www.bea.com/wli/sb/stages/config">_ActionId-N3f575e5a.N78f33e8.0.166e4c80cda.N7fc7</con7:id>
                                                        <con6:logLevel>warning</con6:logLevel>
                                                        <con6:expr>
                                                            <con7:xqueryText xmlns:con7="http://www.bea.com/wli/sb/stages/config">$AUS_StartSyncReq</con7:xqueryText>
                                                        </con6:expr>
                                                        <con6:message>****AUS_SNPublish.SNStartSyncReq****</con6:message>
                                                    </con6:log>
                                                </con4:requestTransform>
                                                <con4:responseTransform>
                                                    <con6:log xmlns:con6="http://www.bea.com/wli/sb/stages/logging/config">
                                                        <con7:id xmlns:con7="http://www.bea.com/wli/sb/stages/config">_ActionId-N3f575e5a.N78f33e8.0.166e4c80cda.N7f90</con7:id>
                                                        <con6:logLevel>warning</con6:logLevel>
                                                        <con6:expr>
                                                            <con7:xqueryText xmlns:con7="http://www.bea.com/wli/sb/stages/config">$AUS_StartSyncRes</con7:xqueryText>
                                                        </con6:expr>
                                                        <con6:message>****AUS_SNPublish.SNStartSyncRes****</con6:message>
                                                    </con6:log>
                                                </con4:responseTransform>
                                            </con4:wsCallout>
                                        </con4:actions>
                                    </con4:case>
                                    <con4:default/>
                                </con4:ifThenElse>
                            </con4:actions>
                        </con4:case>
                        <con4:default/>
                    </con4:ifThenElse>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-a013dc6.N32d0779c.0.16644e0ee58.N7f95">
            <con:stage id="_StageId-a013dc6.N32d0779c.0.16644e0ee58.N7f94" name="Stage1">
                <con:context/>
                <con:actions>
                    <con1:log>
                        <con2:id>_ActionId-a013dc6.N32d0779c.0.16644e0ee58.N7f91</con2:id>
                        <con1:logLevel>error</con1:logLevel>
                        <con1:expr>
                            <con2:xqueryText>$fault</con2:xqueryText>
                        </con1:expr>
                        <con1:message>****AUS_SNPublishAsyncPS.RouteEH.Fault****</con1:message>
                    </con1:log>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-a013dc6.N2d0d734a.0.165fbf2cec9.N7f9d">
            <con:stage id="_StageId-a013dc6.N2d0d734a.0.165fbf2cec9.N7f9b" name="FetchVariables">
                <con:context/>
                <con:actions>
                    <con1:log>
                        <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d48</con2:id>
                        <con1:logLevel>warning</con1:logLevel>
                        <con1:expr>
                            <con2:xqueryText>$body</con2:xqueryText>
                        </con1:expr>
                        <con1:message>****AUS_SNPublish.IncomingRequest****</con1:message>
                    </con1:log>
                    <con3:assign varName="InputRequest">
                        <con2:id>_ActionId-a013dc6.N2d0d734a.0.165fbf2cec9.N7f90</con2:id>
                        <con3:expr>
                            <con2:xqueryText>$body</con2:xqueryText>
                        </con3:expr>
                    </con3:assign>
                    <con5:assign varName="BatchId" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                        <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7ef2</con2:id>
                        <con1:expr>
                            <con2:xqueryText>$InputRequest/AUSSNPublishPSRequest/MessageMetaData/BatchId/text()</con2:xqueryText>
                        </con1:expr>
                    </con5:assign>
                    <con1:assign varName="BatchTransactionId" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                        <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7c8d</con2:id>
                        <con5:expr>
                            <con2:xqueryText>fn-bea:execute-sql('jdbc/ESBDevDB',  
xs:QName('TRANID'),
'select TRANSACTION_ID from AUS_TRANSACTIONS where BATCH_ID=? AND RECORD_TYPE=?',$BatchId,'BATCH')//TRANSACTION_ID/text()</con2:xqueryText>
                        </con5:expr>
                    </con1:assign>
                    <con6:ifThenElse xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config">
                        <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7b11</con2:id>
                        <con6:case id="_BranchId-3904eaa8.N5c714004.0.166cb55bbc9.N7b10">
                            <con6:condition>
                                <con2:xqueryText>fn-bea:execute-sql('jdbc/ESBDevDB',  
xs:QName('STATUS'),
'select STATUS from AUS_TRANSACTIONS where TRANSACTION_ID=?',$BatchTransactionId)//STATUS/text()='ERROR'</con2:xqueryText>
                            </con6:condition>
                            <con6:actions>
                                <con2:reply isError="false">
                                    <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7b0f</con2:id>
                                </con2:reply>
                            </con6:actions>
                        </con6:case>
                        <con6:default/>
                    </con6:ifThenElse>
                    <con5:assign varName="TranId" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                        <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7eee</con2:id>
                        <con1:expr>
                            <con2:xqueryText>$InputRequest/AUSSNPublishPSRequest/MessageMetaData/TranId/text()</con2:xqueryText>
                        </con1:expr>
                    </con5:assign>
                    <con5:assign varName="LastRecord" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                        <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7eeb</con2:id>
                        <con1:expr>
                            <con2:xqueryText>$InputRequest/AUSSNPublishPSRequest/MessageMetaData/LastRecord/text()</con2:xqueryText>
                        </con1:expr>
                    </con5:assign>
                    <con5:assign varName="AccessToken" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                        <con2:id>_ActionId-a013dc6.15285688.0.166115bf98b.N7fcd</con2:id>
                        <con1:expr>
                            <con2:xqueryText>$InputRequest/AUSSNPublishPSRequest/MessageMetaData/AccessToken/text()</con2:xqueryText>
                        </con1:expr>
                    </con5:assign>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-a013dc6.460d90c.0.1660b304c78.N7fa8" name="CheckGroup.Stg">
                <con:context>
                    <con2:userNsDecl prefix="grpl" namespace="http://www.sita.aero/grouplist"/>
                    <con2:userNsDecl prefix="delta" namespace="http://www.sita.aero/getdelta"/>
                </con:context>
                <con:actions>
                    <con3:ifThenElse>
                        <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7f9e</con2:id>
                        <con3:case id="_BranchId-a013dc6.460d90c.0.1660b304c78.N7f9d">
                            <con3:condition>
                                <con2:xqueryText>$InputRequest/AUSSNPublishPSRequest/User/*:accountEnabled/text()='true'</con2:xqueryText>
                            </con3:condition>
                            <con3:actions>
                                <con3:wsCallout>
                                    <con2:id>_ActionId-a013dc6.498af3ce.0.1661a1da01c.N7ffb</con2:id>
                                    <con3:service ref="AzureADUserSync/BusinessServices/AzureAD/FetchADUsersBS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con3:operation>getgrouplist</con3:operation>
                                    <con3:request>
                                        <con3:payload wrapped="false">GroupDetailRequest</con3:payload>
                                    </con3:request>
                                    <con3:response>
                                        <con3:payload wrapped="false">GroupDetailJsonResponse</con3:payload>
                                    </con3:response>
                                    <con3:requestTransform>
                                        <con6:replace contents-only="true" varName="outbound" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-a013dc6.498af3ce.0.1661a1da01c.N7fc7</con2:id>
                                            <con1:location>
                                                <con2:xpathText>./ctx:transport/ctx:request/tp:headers</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xqueryText>&lt;tp:user-header name="Authorization" value="Bearer {$AccessToken}"/></con2:xqueryText>
                                            </con1:expr>
                                        </con6:replace>
                                        <con1:insert varName="outbound" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-a013dc6.498af3ce.0.1661a1da01c.N7fbd</con2:id>
                                            <con1:location>
                                                <con2:xpathText>./ctx:transport/ctx:request</con2:xpathText>
                                            </con1:location>
                                            <con1:where>last-child</con1:where>
                                            <con1:expr>
                                                <con2:xqueryText>&lt;tp:user-metadata name='userId' value='{$InputRequest/AUSSNPublishPSRequest/User/*:id/text()}' /></con2:xqueryText>
                                            </con1:expr>
                                        </con1:insert>
                                        <con4:log xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d45</con2:id>
                                            <con4:logLevel>warning</con4:logLevel>
                                            <con4:expr>
                                                <con2:xqueryText>$outbound</con2:xqueryText>
                                            </con4:expr>
                                            <con4:message>****AUS_SNPublish.CheckGroupRequest****</con4:message>
                                        </con4:log>
                                    </con3:requestTransform>
                                    <con3:responseTransform>
                                        <con1:assign varName="GroupDetailResponse" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-a013dc6.3d18e46e.0.1661baa6a7b.N7efc</con2:id>
                                            <con1:expr>
                                                <con2:xqueryText>fn:replace(fn:replace($GroupDetailJsonResponse, '@odata.context', '_odata.context'),'@odata.type','_odata.type')</con2:xqueryText>
                                            </con1:expr>
                                        </con1:assign>
                                        <con3:nxsdTranslation>
                                            <con2:id>_ActionId-a013dc6.498af3ce.0.1661a1da01c.N7f48</con2:id>
                                            <con3:type>Native-To-XML</con3:type>
                                            <con3:sourceExpr>
                                                <con2:xqueryText>$GroupDetailResponse</con2:xqueryText>
                                            </con3:sourceExpr>
                                            <con3:nxsd ref="AzureADUserSync/Resources/Schemas/GroupDetailResponse"/>
                                            <con3:schemaElement xmlns:gro="http://www.sita.aero/grouplist">gro:Group</con3:schemaElement>
                                            <con3:assign-variable>GroupDetailResponse</con3:assign-variable>
                                        </con3:nxsdTranslation>
                                        <con4:log xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d42</con2:id>
                                            <con4:logLevel>warning</con4:logLevel>
                                            <con4:expr>
                                                <con2:xqueryText>$GroupDetailResponse</con2:xqueryText>
                                            </con4:expr>
                                            <con4:message>****AUS_SNPublish.CheckGroupResponse****</con4:message>
                                        </con4:log>
                                    </con3:responseTransform>
                                </con3:wsCallout>
                                <con3:assign varName="Groups">
                                    <con2:id>_ActionId-a013dc6.498af3ce.0.1661a1da01c.N7f11</con2:id>
                                    <con3:expr>
                                        <con2:xqueryText>fn-bea:serialize($GroupDetailResponse/*:value/*:displayName/text())</con2:xqueryText>
                                    </con3:expr>
                                </con3:assign>
                                <con3:assign varName="RealUser">
                                    <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7e34</con2:id>
                                    <con3:expr>
                                        <con2:xqueryText>if(
fn:contains($Groups,'AZR-AG-ALL Comnet-DYN-Security') or 
fn:contains($Groups,'AZR-AG-All ERM Externals-DYN-Security-Group') or 
fn:contains($Groups,'AZR-AG-All JV_Aviareto-DYN-Security-Group') or 
fn:contains($Groups,'AZR-AG-All JV_Champs-DYN-Security-Group') or 
fn:contains($Groups,'AZR-AG-All JV_OnAir-DYN-Security-Group') or 
fn:contains($Groups,'AZR-AG-All Permanents-DYN-Security-Group') or 
fn:contains($Groups,'AZR-AG-All Permanents Includes the JV (SITAOnAir)-DYN-Security-Group') or 
fn:contains($Groups,'AZR-AG-All Third Party Externals-DYN-Security-Group')
)
then('Y')
else('N')</con2:xqueryText>
                                    </con3:expr>
                                </con3:assign>
                            </con3:actions>
                        </con3:case>
                        <con3:default/>
                    </con3:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-a013dc6.460d90c.0.1660b304c78.N8000" name="GetManager.Stg">
                <con:context>
                    <con2:userNsDecl prefix="delta" namespace="http://www.sita.aero/getdelta"/>
                </con:context>
                <con:actions>
                    <con3:ifThenElse>
                        <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7fb9</con2:id>
                        <con3:case id="_BranchId-a013dc6.460d90c.0.1660b304c78.N7fb8">
                            <con3:condition>
                                <con2:xqueryText>fn:exists($InputRequest/AUSSNPublishPSRequest/User/*:manager_delta)</con2:xqueryText>
                            </con3:condition>
                            <con3:actions>
                                <con3:wsCallout>
                                    <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7ffd</con2:id>
                                    <con3:service ref="AzureADUserSync/BusinessServices/AzureAD/FetchADUsersBS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con3:operation>getmanager</con3:operation>
                                    <con3:request>
                                        <con3:payload wrapped="false">GetManagerRequest</con3:payload>
                                    </con3:request>
                                    <con3:response>
                                        <con3:payload wrapped="false">GetManagerJsonResponse</con3:payload>
                                    </con3:response>
                                    <con3:requestTransform>
                                        <con6:replace contents-only="true" varName="outbound" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7fc9</con2:id>
                                            <con1:location>
                                                <con2:xpathText>./ctx:transport/ctx:request/tp:headers</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xqueryText>&lt;tp:user-header name="Authorization" value="Bearer {$AccessToken}"/></con2:xqueryText>
                                            </con1:expr>
                                        </con6:replace>
                                        <con1:insert varName="outbound" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7fc6</con2:id>
                                            <con1:location>
                                                <con2:xpathText>./ctx:transport/ctx:request</con2:xpathText>
                                            </con1:location>
                                            <con1:where>last-child</con1:where>
                                            <con1:expr>
                                                <con2:xqueryText>&lt;tp:user-metadata name='managerId' value='{$InputRequest/AUSSNPublishPSRequest/User/*:manager_delta[not(exists(*:_removed))]/*:id/text()}' /></con2:xqueryText>
                                            </con1:expr>
                                        </con1:insert>
                                        <con4:log xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d3d</con2:id>
                                            <con4:logLevel>warning</con4:logLevel>
                                            <con4:expr>
                                                <con2:xqueryText>$GetManagerRequest</con2:xqueryText>
                                            </con4:expr>
                                            <con4:message>****AUS_SNPublish.GetManagerRequest****</con4:message>
                                        </con4:log>
                                    </con3:requestTransform>
                                    <con3:responseTransform>
                                        <con1:assign varName="GetManagerResponse" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-a013dc6.15285688.0.166115bf98b.N7fca</con2:id>
                                            <con1:expr>
                                                <con2:xqueryText>fn:replace($GetManagerJsonResponse, '@odata.context', '_odata.context')</con2:xqueryText>
                                            </con1:expr>
                                        </con1:assign>
                                        <con3:nxsdTranslation>
                                            <con2:id>_ActionId-a013dc6.460d90c.0.1660b304c78.N7fac</con2:id>
                                            <con3:type>Native-To-XML</con3:type>
                                            <con3:sourceExpr>
                                                <con2:xqueryText>$GetManagerResponse</con2:xqueryText>
                                            </con3:sourceExpr>
                                            <con3:nxsd ref="AzureADUserSync/Resources/Schemas/GetManagerResponse"/>
                                            <con3:schemaElement xmlns:get="http://www.sita.aero/getmanager">get:Manager</con3:schemaElement>
                                            <con3:assign-variable>GetManagerResponse</con3:assign-variable>
                                        </con3:nxsdTranslation>
                                        <con4:log xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                                            <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d3b</con2:id>
                                            <con4:logLevel>warning</con4:logLevel>
                                            <con4:expr>
                                                <con2:xqueryText>$GetManagerResponse</con2:xqueryText>
                                            </con4:expr>
                                            <con4:message>****AUS_SNPublish.GetManagerResponse****</con4:message>
                                        </con4:log>
                                    </con3:responseTransform>
                                </con3:wsCallout>
                            </con3:actions>
                        </con3:case>
                        <con3:default/>
                    </con3:ifThenElse>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-a013dc6.460d90c.0.1660b304c78.N7dc2">
            <con:stage id="_StageId-a013dc6.N4418d23f.0.16614dd0a26.N7ed8" name="AUSSNPublishAsyncPS.ErrHandler.Stg" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
                <con:context>
                    <con2:userNsDecl prefix="upd" namespace="http://xmlns.oracle.com/pcbpel/adapter/db/top/UpdateAUSTransaction"/>
                    <con2:userNsDecl prefix="delta" namespace="http://www.sita.aero/getdelta"/>
                    <con2:userNsDecl prefix="conf" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con4:log>
                        <con2:id>_ActionId-a013dc6.N4418d23f.0.16614dd0a26.N7ed7</con2:id>
                        <con4:logLevel>error</con4:logLevel>
                        <con4:expr>
                            <con2:xqueryText>$fault</con2:xqueryText>
                        </con4:expr>
                        <con4:message>****AUSSNPublish.EH.Fault****</con4:message>
                    </con4:log>
                    <con3:route>
                        <con2:id>_ActionId-a013dc6.N4418d23f.0.16614dd0a26.N7ed6</con2:id>
                        <con3:service ref="AzureADUserSync/BusinessServices/UpdateAUSTransaction" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con3:operation>merge</con3:operation>
                        <con3:outboundTransform>
                            <con5:replace contents-only="true" varName="body" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                <con2:id>_ActionId-a013dc6.N4418d23f.0.16614dd0a26.N7ed5</con2:id>
                                <con5:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con5:location>
                                <con5:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="AzureADUserSync/Resources/XQueries/UpdateAUSTransactionRequest"/>
                                        <con2:param name="Status">
                                            <con2:path>'ERROR'</con2:path>
                                        </con2:param>
                                        <con2:param name="NextLink">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="Deltalink">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="RecordType">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="errCode">
                                            <con2:path>$fault/ctx:errorCode/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="BatchId">
                                            <con2:path>$BatchId</con2:path>
                                        </con2:param>
                                        <con2:param name="errMsg">
                                            <con2:path>$fault/ctx:reason/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="Payload">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="RecordCount">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="TransactionId">
                                            <con2:path>$TranId</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con5:expr>
                            </con5:replace>
                        </con3:outboundTransform>
                    </con3:route>
                    <con6:ifThenElse xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config">
                        <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7c0e</con2:id>
                        <con6:case id="_BranchId-3904eaa8.N5c714004.0.166cb55bbc9.N7c0d">
                            <con6:condition>
                                <con2:xqueryText>fn-bea:execute-sql('jdbc/ESBDevDB',  
xs:QName('STATUS'),
'select STATUS from AUS_TRANSACTIONS where TRANSACTION_ID=?',$BatchTransactionId)//STATUS/text()='ERROR'</con2:xqueryText>
                            </con6:condition>
                            <con6:actions/>
                        </con6:case>
                        <con6:default>
                            <con3:route>
                                <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7c0c</con2:id>
                                <con3:service ref="AzureADUserSync/BusinessServices/UpdateAUSTransaction" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>merge</con3:operation>
                                <con3:outboundTransform>
                                    <con5:replace contents-only="true" varName="body" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                        <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7c0b</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="AzureADUserSync/Resources/XQueries/UpdateAUSTransactionRequest"/>
                                                <con2:param name="Status">
                                                    <con2:path>'ERROR'</con2:path>
                                                </con2:param>
                                                <con2:param name="NextLink">
                                                    <con2:path>''</con2:path>
                                                </con2:param>
                                                <con2:param name="Deltalink">
                                                    <con2:path>''</con2:path>
                                                </con2:param>
                                                <con2:param name="RecordType">
                                                    <con2:path>''</con2:path>
                                                </con2:param>
                                                <con2:param name="errCode">
                                                    <con2:path>$fault/ctx:errorCode/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="BatchId">
                                                    <con2:path>$BatchId</con2:path>
                                                </con2:param>
                                                <con2:param name="errMsg">
                                                    <con2:path>fn:substring($fault/ctx:reason/text(),1,200)</con2:path>
                                                </con2:param>
                                                <con2:param name="Payload">
                                                    <con2:path>''</con2:path>
                                                </con2:param>
                                                <con2:param name="RecordCount">
                                                    <con2:path>''</con2:path>
                                                </con2:param>
                                                <con2:param name="TransactionId">
                                                    <con2:path>$BatchTransactionId</con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con5:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con7:route xmlns:con5="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con7="http://www.bea.com/wli/sb/stages/publish/config">
                                <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7c0a</con2:id>
                                <con3:service ref="Common/BusinessServices/Send_Email" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:outboundTransform>
                                    <con6:assign varName="EnvironmentName">
                                        <con2:id>_ActionId-a013dd4.4fb81c68.0.168842c769c.N7fc4</con2:id>
                                        <con6:expr>
                                            <con2:xqueryText>if(fn:contains(fn:substring-before(fn-bea:getHostname(), "."), "dev"))then
"DEV"
else if(fn:contains(fn:substring-before(fn-bea:getHostname(), "."), "qa")) then
"QA"
else if (fn:contains(fn:substring-before(fn-bea:getHostname(), "."), "prod")) then
"PROD"
else
fn:substring-before(fn-bea:getHostname(),".")</con2:xqueryText>
                                        </con6:expr>
                                    </con6:assign>
                                    <con1:transport-headers>
                                        <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7c09</con2:id>
                                        <con1:header-set>outbound-request</con1:header-set>
                                        <con1:header value="expression" name="Subject">
                                            <con2:xqueryText>fn:concat($EnvironmentName,' : Error Occurred with AzureADUserSync with Batch ID: ',$BatchId)</con2:xqueryText>
                                        </con1:header>
                                        <con6:header value="expression" name="To">
                                            <con2:xqueryText>fn-bea:execute-sql('jdbc/ESBDevDB', xs:QName('MAILTO'), 'SELECT VALUE FROM ESB_DEPLOYMENT_CONFIG WHERE KEY=?','bs_mailto_Send_Email')/VALUE/text()</con2:xqueryText>
                                        </con6:header>
                                    </con1:transport-headers>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7c08</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryText>fn:concat('AzureADUserSync Failed in ',$EnvironmentName,' environment with: 
Error Code: ',$fault/ctx:errorCode/text(),'
Error Message: ',$fault/ctx:reason/text())</con2:xqueryText>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con7:route>
                        </con6:default>
                    </con6:ifThenElse>
                    <con2:reply>
                        <con2:id>_ActionId-a013dc6.N4418d23f.0.16614dd0a26.N7ed4</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:flow>
            <con:pipeline-node name="AUS_SNPublishAsync_PP">
                <con:request>request-a013dc6.N2d0d734a.0.165fbf2cec9.N7f9d</con:request>
                <con:response>response-a013dc6.N2d0d734a.0.165fbf2cec9.N7f9c</con:response>
            </con:pipeline-node>
            <con:route-node name="AUS_SNPublish_RN" error-handler="error-a013dc6.N32d0779c.0.16644e0ee58.N7f95">
                <con:context/>
                <con:actions>
                    <con3:ifThenElse>
                        <con2:id>_ActionId-a013dc6.N530c4973.0.1663fb21a3c.N7f90</con2:id>
                        <con3:case id="_BranchId-a013dc6.N530c4973.0.1663fb21a3c.N7f8f">
                            <con3:condition>
                                <con2:xqueryText>$RealUser='Y' or $InputRequest/AUSSNPublishPSRequest/User/*:accountEnabled/text()='false'</con2:xqueryText>
                            </con3:condition>
                            <con3:actions>
                                <con4:route>
                                    <con2:id>_ActionId-a013dc6.N530c4973.0.1663fb21a3c.N7f8c</con2:id>
                                    <con4:service ref="AzureADUserSync/BusinessServices/ServiceNow/SNUserPublishBS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con4:operation>insert</con4:operation>
                                    <con4:outboundTransform>
                                        <con3:replace varName="body" contents-only="true">
                                            <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7f06</con2:id>
                                            <con3:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con3:location>
                                            <con3:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="AzureADUserSync/Resources/XQueries/CreateSNRequest"/>
                                                    <con2:param name="DeltaUser">
                                                        <con2:path>$InputRequest/AUSSNPublishPSRequest/User</con2:path>
                                                    </con2:param>
                                                    <con2:param name="Manager">
                                                        <con2:path>$GetManagerResponse</con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con3:expr>
                                        </con3:replace>
                                        <con1:log>
                                            <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d88</con2:id>
                                            <con1:logLevel>warning</con1:logLevel>
                                            <con1:expr>
                                                <con2:xqueryText>$body</con2:xqueryText>
                                            </con1:expr>
                                            <con1:message>****AUS_SNPublish.Route.SNRequest****</con1:message>
                                        </con1:log>
                                    </con4:outboundTransform>
                                    <con4:responseTransform>
                                        <con1:log>
                                            <con2:id>_ActionId-3904eaa8.N5c714004.0.166cb55bbc9.N7d54</con2:id>
                                            <con1:logLevel>warning</con1:logLevel>
                                            <con1:expr>
                                                <con2:xqueryText>$body</con2:xqueryText>
                                            </con1:expr>
                                            <con1:message>****AUS_SNPublish.Route.SNResponse****</con1:message>
                                        </con1:log>
                                    </con4:responseTransform>
                                </con4:route>
                            </con3:actions>
                        </con3:case>
                        <con3:default/>
                    </con3:ifThenElse>
                </con:actions>
            </con:route-node>
        </con:flow>
    </con:router>
</con:pipelineEntry>